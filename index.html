<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug - IntegraÃ§Ã£o Forms + GitHub</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 { color: #333; text-align: center; }
    h2 { color: #4285F4; border-bottom: 2px solid #4285F4; padding-bottom: 5px; }
    h3 { color: #666; }
    
    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
      margin: 5px 0;
      font-family: monospace;
      font-size: 12px;
    }
    
    button {
      background-color: #4285F4;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background-color: #3367D6; }
    
    .test-btn { background-color: #FF9800; }
    .test-btn:hover { background-color: #F57C00; }
    
    .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin: 10px 0; }
    .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0; }
    .info { background: #cce8ff; color: #004085; padding: 10px; border-radius: 5px; margin: 10px 0; }
    .warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0; }
    
    .debug-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      border-left: 4px solid #6c757d;
    }
    
    .data-preview {
      background: #f1f3f4;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 11px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin: 10px 0;
    }
    
    .step {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin: 10px 0;
    }
    
    .step.completed { border-color: #28a745; background: #f8fff9; }
    .step.error { border-color: #dc3545; background: #fff8f8; }
    .step.processing { border-color: #ffc107; background: #fffef7; }
    
    .small-text { font-size: 11px; color: #666; margin: 5px 0; }
  </style>
</head>
<body>
  <h1>ğŸ”§ Debug - IntegraÃ§Ã£o Forms + GitHub</h1>
  
  <div class="container">
    <h2>ğŸ¯ ConfiguraÃ§Ã£o e Teste</h2>
    
    <div class="step" id="step1">
      <h3>ğŸ“‹ Passo 1: URL do Google Forms/Sheets</h3>
      <input type="text" id="formsUrl" placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv">
      <div class="small-text">Cole aqui a URL de exportaÃ§Ã£o CSV da sua planilha do Google Forms</div>
      <button class="test-btn" onclick="testFormsUrl()">ğŸ§ª Testar URL do Forms</button>
      <div id="formsResult"></div>
    </div>
    
    <div class="step" id="step2">
      <h3>ğŸ“Š Passo 2: URL do GitHub (Base de Dados)</h3>
      <input type="text" id="githubUrl" placeholder="https://raw.githubusercontent.com/usuario/repo/main/jogadores.csv">
      <div class="small-text">Cole aqui a URL RAW do arquivo CSV no GitHub com todos os jogadores</div>
      <button class="test-btn" onclick="testGithubUrl()">ğŸ§ª Testar URL do GitHub</button>
      <div id="githubResult"></div>
    </div>
    
    <div class="step" id="step3">
      <h3>ğŸ”„ Passo 3: Processamento Completo</h3>
      <button onclick="processIntegration()" id="processBtn" disabled>ğŸš€ Processar IntegraÃ§Ã£o</button>
      <div id="processResult"></div>
    </div>
  </div>

  <div class="container" id="debugInfo" style="display: none;">
    <h2>ğŸ” InformaÃ§Ãµes de Debug</h2>
    <div id="debugDetails"></div>
  </div>

  <div class="container" id="finalResult" style="display: none;">
    <h2>âœ… Resultado Final</h2>
    <div id="finalData"></div>
    <button onclick="downloadResult()" id="downloadBtn" style="display: none;">ğŸ’¾ Download CSV</button>
  </div>

  <div class="container">
    <h2>ğŸ’¡ Dicas de SoluÃ§Ã£o</h2>
    <div class="info">
      <strong>Problemas Comuns:</strong>
      <ul>
        <li><strong>URL do Forms:</strong> Certifique-se que termina com <code>/export?format=csv</code></li>
        <li><strong>PermissÃµes:</strong> A planilha deve ser pÃºblica ou vocÃª deve estar logado</li>
        <li><strong>URL do GitHub:</strong> Use SEMPRE o link RAW, nÃ£o o link normal</li>
        <li><strong>CORS:</strong> Alguns navegadores bloqueiam requisiÃ§Ãµes, teste em abas privadas</li>
        <li><strong>Formato:</strong> Verifique se os nomes nos dois arquivos coincidem exatamente</li>
      </ul>
    </div>
  </div>

  <script>
    let formsData = null;
    let githubData = null;
    let step1Ok = false;
    let step2Ok = false;

    function updateUI() {
      const processBtn = document.getElementById('processBtn');
      processBtn.disabled = !(step1Ok && step2Ok);
      
      document.getElementById('step1').className = step1Ok ? 'step completed' : 'step';
      document.getElementById('step2').className = step2Ok ? 'step completed' : 'step';
    }

    async function testFormsUrl() {
      const url = document.getElementById('formsUrl').value.trim();
      const resultDiv = document.getElementById('formsResult');
      
      if (!url) {
        resultDiv.innerHTML = '<div class="error">âŒ Por favor, cole a URL do Google Sheets</div>';
        return;
      }
      
      if (!url.includes('docs.google.com') || !url.includes('export?format=csv')) {
        resultDiv.innerHTML = '<div class="warning">âš ï¸ URL suspeita. Certifique-se que Ã© uma URL de exportaÃ§Ã£o CSV</div>';
      }
      
      resultDiv.innerHTML = '<div class="info">ğŸ”„ Testando conexÃ£o com Google Sheets...</div>';
      
      try {
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
        }
        
        const text = await response.text();
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length === 0) {
          throw new Error('Arquivo CSV vazio');
        }
        
        formsData = parseCSV(text, true);
        
        let preview = `Primeira linha (cabeÃ§alho): ${lines[0]}\n`;
        preview += `Total de linhas: ${lines.length}\n`;
        preview += `Dados processados: ${formsData.length} registros\n\n`;
        preview += 'Primeiras 3 linhas de dados:\n';
        formsData.slice(0, 3).forEach((row, i) => {
          preview += `${i + 1}: ${JSON.stringify(row)}\n`;
        });
        
        resultDiv.innerHTML = `
          <div class="success">âœ… Google Sheets conectado com sucesso!</div>
          <div class="data-preview">${preview}</div>
        `;
        
        step1Ok = true;
        updateUI();
        
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">âŒ Erro ao acessar Google Sheets: ${error.message}</div>
          <div class="debug-section">
            <strong>Debug:</strong><br>
            URL: ${url}<br>
            Erro: ${error.toString()}
          </div>
        `;
        step1Ok = false;
        updateUI();
      }
    }

    async function testGithubUrl() {
      const url = document.getElementById('githubUrl').value.trim();
      const resultDiv = document.getElementById('githubResult');
      
      if (!url) {
        resultDiv.innerHTML = '<div class="error">âŒ Por favor, cole a URL do GitHub</div>';
        return;
      }
      
      if (!url.includes('raw.githubusercontent.com')) {
        resultDiv.innerHTML = '<div class="warning">âš ï¸ URL deve ser RAW do GitHub (raw.githubusercontent.com)</div>';
      }
      
      resultDiv.innerHTML = '<div class="info">ğŸ”„ Testando conexÃ£o com GitHub...</div>';
      
      try {
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
        }
        
        const text = await response.text();
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length === 0) {
          throw new Error('Arquivo CSV vazio');
        }
        
        githubData = parseCSV(text, true);
        
        let preview = `Primeira linha (cabeÃ§alho): ${lines[0]}\n`;
        preview += `Total de jogadores: ${githubData.length}\n\n`;
        preview += 'Primeiros 5 jogadores:\n';
        githubData.slice(0, 5).forEach((row, i) => {
          if (row.length >= 3) {
            preview += `${i + 1}: ${row[0]} - ${row[1]} - ${row[2]}\n`;
          }
        });
        
        resultDiv.innerHTML = `
          <div class="success">âœ… GitHub conectado com sucesso!</div>
          <div class="data-preview">${preview}</div>
        `;
        
        step2Ok = true;
        updateUI();
        
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">âŒ Erro ao acessar GitHub: ${error.message}</div>
          <div class="debug-section">
            <strong>Debug:</strong><br>
            URL: ${url}<br>
            Erro: ${error.toString()}
          </div>
        `;
        step2Ok = false;
        updateUI();
      }
    }

function parseCSV(csv) {
  const rows = csv.split('\n');
  return rows.map(row => {
    const columns = [];
    let current = '';
    let inQuotes = false;

    for (let char of row) {
      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        columns.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    columns.push(current.trim());

    // Remove TODAS as aspas
    let cleanCols = columns.map(col => col.replace(/"/g, '').trim());

    // Se o primeiro campo tiver Nome e PosiÃ§Ã£o juntos, separa
    if (cleanCols.length === 2 && cleanCols[0].includes(',')) {
      const [nome, posicao] = cleanCols[0].split(',').map(s => s.trim());
      cleanCols = [nome, posicao, cleanCols[1]];
    }

    return cleanCols;
  });
}

    function normalizeString(str) {
      return str.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^\w\s]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function processIntegration() {
      if (!formsData || !githubData) {
        document.getElementById('processResult').innerHTML = 
          '<div class="error">âŒ Execute os testes dos Passos 1 e 2 primeiro</div>';
        return;
      }
      
      document.getElementById('step3').className = 'step processing';
      document.getElementById('processResult').innerHTML = 
        '<div class="info">ğŸ”„ Processando integraÃ§Ã£o...</div>';
      
      try {
        const matched = [];
        const notFound = [];
        const debugInfo = [];
        
        // Analisa estrutura dos dados do Forms
        debugInfo.push(`Estrutura Forms: ${formsData.length} registros`);
        if (formsData.length > 0) {
          debugInfo.push(`Exemplo Forms: ${JSON.stringify(formsData[0])}`);
        }
        
        // Analisa estrutura dos dados do GitHub
        debugInfo.push(`Estrutura GitHub: ${githubData.length} registros`);
        if (githubData.length > 0) {
          debugInfo.push(`Exemplo GitHub: ${JSON.stringify(githubData[0])}`);
        }
        
        formsData.forEach((formRow, formIndex) => {
          if (formRow.length < 2) return;
          
          // Assume que o nome estÃ¡ na segunda coluna (apÃ³s timestamp)
          const formName = formRow[1]?.trim();
          if (!formName) return;
          
          debugInfo.push(`Procurando: "${formName}"`);
          
          const githubMatch = githubData.find((githubRow, githubIndex) => {
            if (githubRow.length < 1) return false;
            const githubName = githubRow[0]?.trim();
            const match = normalizeString(githubName) === normalizeString(formName);
            if (match) {
              debugInfo.push(`  âœ… Encontrado: "${githubName}" (linha ${githubIndex + 1})`);
            }
            return match;
          });
          
          if (githubMatch && githubMatch.length >= 3) {
            matched.push({
              name: githubMatch[0].trim(),
              position: githubMatch[1].trim(),
              birthYear: githubMatch[2].trim()
            });
          } else {
            notFound.push({ name: formName });
            debugInfo.push(`  âŒ NÃ£o encontrado: "${formName}"`);
          }
        });
        
        // Mostra debug
        document.getElementById('debugInfo').style.display = 'block';
        document.getElementById('debugDetails').innerHTML = `
          <div class="data-preview">${debugInfo.join('\n')}</div>
        `;
        
        // Gera resultado
        generateResult(matched, notFound);
        
        document.getElementById('step3').className = 'step completed';
        document.getElementById('processResult').innerHTML = `
          <div class="success">âœ… Processamento concluÃ­do! ${matched.length} encontrados, ${notFound.length} nÃ£o encontrados</div>
        `;
        
      } catch (error) {
        document.getElementById('step3').className = 'step error';
        document.getElementById('processResult').innerHTML = `
          <div class="error">âŒ Erro no processamento: ${error.message}</div>
        `;
      }
    }

    function generateResult(matched, notFound) {
Â  Â  Â  // CabeÃ§alho do CSV com 3 colunas
Â  Â  Â  let csv = 'Nome,PosiÃ§Ã£o,Nascimento\n';
Â  Â  Â 
Â  Â  Â  // Monta cada linha do CSV corretamente
Â  Â  Â  matched.forEach(player => {
        // LINHA CORRIGIDA: Gera 3 colunas separadas por vÃ­rgula e sem aspas
Â  Â  Â  Â  csv += `${player.name},${player.position},${player.birthYear}\n`;
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  window.resultCSV = csv;
Â  Â  Â Â 
Â  Â  Â  let resultHtml = `
Â  Â  Â  Â  <h3>âœ… Jogadores Encontrados (${matched.length})</h3>
Â  Â  Â  Â  <div class="data-preview">${csv.replace(/\n/g, '<br>')}</div>
Â  Â  Â  `;
Â  Â  Â Â 
Â  Â  Â  if (notFound.length > 0) {
Â  Â  Â  Â  resultHtml += `
Â  Â  Â  Â  Â  <h3>âŒ NÃ£o Encontrados (${notFound.length})</h3>
Â  Â  Â  Â  Â  <div class="data-preview">${notFound.map(p => p.name).join('<br>')}</div>
Â  Â  Â  Â  `;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  document.getElementById('finalData').innerHTML = resultHtml;
Â  Â  Â  document.getElementById('finalResult').style.display = 'block';
Â  Â  Â  document.getElementById('downloadBtn').style.display = 'inline-block';
}
    function downloadResult() {
      if (!window.resultCSV) return;
      
      const blob = new Blob([window.resultCSV], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `jogadores.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Carrega URLs salvas
    document.addEventListener('DOMContentLoaded', () => {
      const savedFormsUrl = localStorage.getItem('formsUrl');
      const savedGithubUrl = localStorage.getItem('githubUrl');
      
      if (savedFormsUrl) document.getElementById('formsUrl').value = savedFormsUrl;
      if (savedGithubUrl) document.getElementById('githubUrl').value = savedGithubUrl;
    });

    // Salva URLs
    document.getElementById('formsUrl').addEventListener('input', (e) => {
      localStorage.setItem('formsUrl', e.target.value);
    });

    document.getElementById('githubUrl').addEventListener('input', (e) => {
      localStorage.setItem('githubUrl', e.target.value);
    });
  </script>
</body>
</html>
