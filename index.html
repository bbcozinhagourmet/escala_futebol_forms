<script>
Â  Â  let formsData = null;
Â  Â  let githubData = null;
Â  Â  let step1Ok = false;
Â  Â  let step2Ok = false;

Â  Â  function updateUI() {
Â  Â  Â  const processBtn = document.getElementById('processBtn');
Â  Â  Â  processBtn.disabled = !(step1Ok && step2Ok);
Â  Â  Â Â 
Â  Â  Â  document.getElementById('step1').className = step1Ok ? 'step completed' : 'step';
Â  Â  Â  document.getElementById('step2').className = step2Ok ? 'step completed' : 'step';
Â  Â  }

Â  Â  async function testFormsUrl() {
Â  Â  Â  const url = document.getElementById('formsUrl').value.trim();
Â  Â  Â  const resultDiv = document.getElementById('formsResult');
Â  Â  Â Â 
Â  Â  Â  if (!url) {
Â  Â  Â  Â  resultDiv.innerHTML = '<div class="error">âŒ Por favor, cole a URL do Google Sheets</div>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  if (!url.includes('docs.google.com') || !url.includes('export?format=csv')) {
Â  Â  Â  Â  resultDiv.innerHTML = '<div class="warning">âš ï¸ URL suspeita. Certifique-se que Ã© uma URL de exportaÃ§Ã£o CSV</div>';
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  resultDiv.innerHTML = '<div class="info">ğŸ”„ Testando conexÃ£o com Google Sheets...</div>';
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(url);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const text = await response.text();
Â  Â  Â  Â  const lines = text.split('\n').filter(line => line.trim());
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (lines.length === 0) {
Â  Â  Â  Â  Â  throw new Error('Arquivo CSV vazio');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  formsData = parseCSV(text, true);
Â  Â  Â  Â Â 
Â  Â  Â  Â  let preview = `Primeira linha (cabeÃ§alho): ${lines[0]}\n`;
Â  Â  Â  Â  preview += `Total de linhas: ${lines.length}\n`;
Â  Â  Â  Â  preview += `Dados processados: ${formsData.length} registros\n\n`;
Â  Â  Â  Â  preview += 'Primeiras 3 linhas de dados:\n';
Â  Â  Â  Â  formsData.slice(0, 3).forEach((row, i) => {
Â  Â  Â  Â  Â  preview += `${i + 1}: ${JSON.stringify(row)}\n`;
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  resultDiv.innerHTML = `
Â  Â  Â  Â  Â  <div class="success">âœ… Google Sheets conectado com sucesso!</div>
Â  Â  Â  Â  Â  <div class="data-preview">${preview}</div>
Â  Â  Â  Â  `;
Â  Â  Â  Â Â 
Â  Â  Â  Â  step1Ok = true;
Â  Â  Â  Â  updateUI();
Â  Â  Â  Â Â 
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  resultDiv.innerHTML = `
Â  Â  Â  Â  Â  <div class="error">âŒ Erro ao acessar Google Sheets: ${error.message}</div>
Â  Â  Â  Â  Â  <div class="debug-section">
Â  Â  Â  Â  Â  Â  <strong>Debug:</strong><br>
Â  Â  Â  Â  Â  Â  URL: ${url}<br>
Â  Â  Â  Â  Â  Â  Erro: ${error.toString()}
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  step1Ok = false;
Â  Â  Â  Â  updateUI();
Â  Â  Â  }
Â  Â  }

Â  Â  async function testGithubUrl() {
Â  Â  Â  const url = document.getElementById('githubUrl').value.trim();
Â  Â  Â  const resultDiv = document.getElementById('githubResult');
Â  Â  Â Â 
Â  Â  Â  if (!url) {
Â  Â  Â  Â  resultDiv.innerHTML = '<div class="error">âŒ Por favor, cole a URL do GitHub</div>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  if (!url.includes('raw.githubusercontent.com')) {
Â  Â  Â  Â  resultDiv.innerHTML = '<div class="warning">âš ï¸ URL deve ser RAW do GitHub (raw.githubusercontent.com)</div>';
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  resultDiv.innerHTML = '<div class="info">ğŸ”„ Testando conexÃ£o com GitHub...</div>';
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  const response = await fetch(url);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const text = await response.text();
Â  Â  Â  Â  const lines = text.split('\n').filter(line => line.trim());
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (lines.length === 0) {
Â  Â  Â  Â  Â  throw new Error('Arquivo CSV vazio');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  githubData = parseCSV(text, true);
Â  Â  Â  Â Â 
Â  Â  Â  Â  let preview = `Primeira linha (cabeÃ§alho): ${lines[0]}\n`;
Â  Â  Â  Â  preview += `Total de jogadores: ${githubData.length}\n\n`;
Â  Â  Â  Â  preview += 'Primeiros 5 jogadores:\n';
Â  Â  Â  Â  githubData.slice(0, 5).forEach((row, i) => {
Â  Â  Â  Â  Â  if (row.length >= 3) {
Â  Â  Â  Â  Â  Â  preview += `${i + 1}: ${row[0]} - ${row[1]} - ${row[2]}\n`;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  resultDiv.innerHTML = `
Â  Â  Â  Â  Â  <div class="success">âœ… GitHub conectado com sucesso!</div>
Â  Â  Â  Â  Â  <div class="data-preview">${preview}</div>
Â  Â  Â  Â  `;
Â  Â  Â  Â Â 
Â  Â  Â  Â  step2Ok = true;
Â  Â  Â  Â  updateUI();
Â  Â  Â  Â Â 
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  resultDiv.innerHTML = `
Â  Â  Â  Â  Â  <div class="error">âŒ Erro ao acessar GitHub: ${error.message}</div>
Â  Â  Â  Â  Â  <div class="debug-section">
Â  Â  Â  Â  Â  Â  <strong>Debug:</strong><br>
Â  Â  Â  Â  Â  Â  URL: ${url}<br>
Â  Â  Â  Â  Â  Â  Erro: ${error.toString()}
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  step2Ok = false;
Â  Â  Â  Â  updateUI();
Â  Â  Â  }
Â  Â  }

function parseCSV(csv) {
Â  const rows = csv.split('\n');
Â  return rows.map(row => {
Â  Â  const columns = [];
Â  Â  let current = '';
Â  Â  let inQuotes = false;

Â  Â  for (let char of row) {
Â  Â  Â  if (char === '"') {
Â  Â  Â  Â  inQuotes = !inQuotes;
Â  Â  Â  } else if (char === ',' && !inQuotes) {
Â  Â  Â  Â  columns.push(current.trim());
Â  Â  Â  Â  current = '';
Â  Â  Â  } else {
Â  Â  Â  Â  current += char;
Â  Â  Â  }
Â  Â  }
Â  Â  columns.push(current.trim());

Â  Â  // Remove TODAS as aspas
Â  Â  let cleanCols = columns.map(col => col.replace(/"/g, '').trim());

Â  Â  // Se o primeiro campo tiver Nome e PosiÃ§Ã£o juntos, separa
Â  Â  if (cleanCols.length === 2 && cleanCols[0].includes(',')) {
Â  Â  Â  const [nome, posicao] = cleanCols[0].split(',').map(s => s.trim());
Â  Â  Â  cleanCols = [nome, posicao, cleanCols[1]];
Â  Â  }

Â  Â  return cleanCols;
Â  });
}

Â  Â  function normalizeString(str) {
Â  Â  Â  return str.toLowerCase()
Â  Â  Â  Â  .normalize('NFD')
Â  Â  Â  Â  .replace(/[\u0300-\u036f]/g, '')
Â  Â  Â  Â  .replace(/[^\w\s]/g, '')
Â  Â  Â  Â  .replace(/\s+/g, ' ')
Â  Â  Â  Â  .trim();
Â  Â  }

Â  Â  function processIntegration() {
Â  Â  Â  if (!formsData || !githubData) {
Â  Â  Â  Â  document.getElementById('processResult').innerHTML =Â 
Â  Â  Â  Â  Â  '<div class="error">âŒ Execute os testes dos Passos 1 e 2 primeiro</div>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  document.getElementById('step3').className = 'step processing';
Â  Â  Â  document.getElementById('processResult').innerHTML =Â 
Â  Â  Â  Â  '<div class="info">ğŸ”„ Processando integraÃ§Ã£o...</div>';
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  const matched = [];
Â  Â  Â  Â  const notFound = [];
Â  Â  Â  Â  const debugInfo = [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  debugInfo.push(`Estrutura Forms: ${formsData.length} registros`);
Â  Â  Â  Â  if (formsData.length > 0) {
Â  Â  Â  Â  Â  debugInfo.push(`Exemplo Forms: ${JSON.stringify(formsData[0])}`);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  debugInfo.push(`Estrutura GitHub: ${githubData.length} registros`);
Â  Â  Â  Â  if (githubData.length > 0) {
Â  Â  Â  Â  Â  debugInfo.push(`Exemplo GitHub: ${JSON.stringify(githubData[0])}`);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  formsData.forEach((formRow, formIndex) => {
Â  Â  Â  Â  Â  if (formRow.length < 2) return;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const formName = formRow[1]?.trim();
Â  Â  Â  Â  Â  if (!formName) return;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  debugInfo.push(`Procurando: "${formName}"`);
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const githubMatch = githubData.find((githubRow, githubIndex) => {
Â  Â  Â  Â  Â  Â  if (githubRow.length < 1) return false;
Â  Â  Â  Â  Â  Â  const githubName = githubRow[0]?.trim();
Â  Â  Â  Â  Â  Â  const match = normalizeString(githubName) === normalizeString(formName);
Â  Â  Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  Â  Â  debugInfo.push(`Â  âœ… Encontrado: "${githubName}" (linha ${githubIndex + 1})`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return match;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (githubMatch && githubMatch.length >= 3) {
Â  Â  Â  Â  Â  Â  matched.push({
Â  Â  Â  Â  Â  Â  Â  name: githubMatch[0].trim(),
Â  Â  Â  Â    Â  Â  position: githubMatch[1].trim(),
Â  Â  Â  Â  Â  Â  Â  birthYear: githubMatch[2].trim()
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  notFound.push({ name: formName });
Â  Â  Â  Â  Â  Â  debugInfo.push(`Â  âŒ NÃ£o encontrado: "${formName}"`);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('debugInfo').style.display = 'block';
Â  Â  Â  Â  document.getElementById('debugDetails').innerHTML = `
Â  Â  Â  Â  Â  <div class="data-preview">${debugInfo.join('\n')}</div>
Â  Â  Â  Â  `;
Â  Â  Â  Â Â 
Â  Â  Â  Â  generateResult(matched, notFound);
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('step3').className = 'step completed';
Â  Â  Â  Â  document.getElementById('processResult').innerHTML = `
Â  Â  Â  Â  Â  <div class="success">âœ… Processamento concluÃ­do! ${matched.length} encontrados, ${notFound.length} nÃ£o encontrados</div>
Â  Â  Â  Â  `;
Â  Â  Â  Â Â 
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  document.getElementById('step3').className = 'step error';
Â  Â  Â  Â  document.getElementById('processResult').innerHTML = `
Â  Â  Â  Â  Â  <div class="error">âŒ Erro no processamento: ${error.message}</div>
Â  Â  Â  Â  `;
Â  Â  Â  }
Â  Â  }

Â  Â  function generateResult(matched, notFound) {
Â  Â  Â  let csv = 'Nome,PosiÃ§Ã£o,Nascimento\n';
Â  Â  Â  matched.forEach(player => {
        // A linha abaixo foi alterada para gerar 3 colunas e remover as aspas
Â  Â  Â  Â  csv += `${player.name},${player.position},${player.birthYear}\n`;
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  window.resultCSV = csv;
Â  Â  Â Â 
Â  Â  Â  let resultHtml = `
Â  Â  Â  Â  <h3>âœ… Jogadores Encontrados (${matched.length})</h3>
Â  Â  Â  Â  <div class="data-preview">${csv}</div>
Â  Â  Â  `;
Â  Â  Â Â 
Â  Â  Â  if (notFound.length > 0) {
Â  Â  Â  Â  resultHtml += `
Â  Â  Â  Â  Â  <h3>âŒ NÃ£o Encontrados (${notFound.length})</h3>
Â  Â  Â  Â  Â  <div class="data-preview">${notFound.map(p => p.name).join('\n')}</div>
Â  Â  Â  Â  `;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  document.getElementById('finalData').innerHTML = resultHtml;
Â  Â  Â  document.getElementById('finalResult').style.display = 'block';
Â  Â  Â  document.getElementById('downloadBtn').style.display = 'inline-block';
Â  Â  }

Â  Â  function downloadResult() {
Â  Â  Â  if (!window.resultCSV) return;
Â  Â  Â Â 
Â  Â  Â  const blob = new Blob([window.resultCSV], { type: 'text/csv;charset=utf-8;' });
Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â Â 
Â  Â  Â  link.setAttribute('href', url);
Â  Â  Â  link.setAttribute('download', `jogadores_presentes_${new Date().toISOString().split('T')[0]}.csv`);
Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  link.click();
Â  Â  Â  document.body.removeChild(link);
Â  Â  }

Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  const savedFormsUrl = localStorage.getItem('formsUrl');
Â  Â  Â  const savedGithubUrl = localStorage.getItem('githubUrl');
Â  Â  Â Â 
Â  Â  Â  if (savedFormsUrl) document.getElementById('formsUrl').value = savedFormsUrl;
Â  Â  Â  if (savedGithubUrl) document.getElementById('githubUrl').value = savedGithubUrl;
Â  Â  });

Â  Â  document.getElementById('formsUrl').addEventListener('input', (e) => {
Â  Â  Â  localStorage.setItem('formsUrl', e.target.value);
Â  Â  });

Â  Â  document.getElementById('githubUrl').addEventListener('input', (e) => {
Â  Â  Â  localStorage.setItem('githubUrl', e.target.value);
Â  Â  });
</script>
